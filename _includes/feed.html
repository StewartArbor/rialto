{% assign lang = page.lang | default: "en" %}

{%- comment -%}
Get all active items
{%- endcomment -%}

{% assign all_items = site.data.items | where: "active", true %}


{%- comment -%}
Filter by category if needed
{%- endcomment -%}

{% if page.cat %}
  {% assign cat_items = all_items | where: "category", page.cat %}
  {% if cat_items.size > 0 %}
    {% assign items = cat_items %}
  {% else %}
    {% assign items = all_items %}
  {% endif %}
{% else %}
  {% assign items = all_items %}
{% endif %}


{%- comment -%}
Score items
{%- endcomment -%}

{% assign scored = "" | split: "" %}

{% for item in items %}

  {% assign discount_score = item.discount | times: 3 %}

  {% assign now = site.time | date: "%s" %}
  {% assign added = item.added | date: "%s" %}

  {% assign days_old = now | minus: added | divided_by: 86400 %}

  {% assign freshness = 60 | minus: days_old %}
  {% if freshness < 0 %}
    {% assign freshness = 0 %}
  {% endif %}

  {% assign score = discount_score | plus: freshness %}

  {% assign ranked = item | merge: {"score": score} %}

  {% assign scored = scored | push: ranked %}

{% endfor %}


{%- comment -%}
Sort by score
{%- endcomment -%}

{% assign items_sorted = scored | sort: "score" | reverse %}


<div class="feed" id="dealFeed">


{% for item in items_sorted %}
{% assign rank = forloop.index %}

{% assign title = item.title[lang] | default: item.title.en %}
{% assign desc  = item.desc[lang]  | default: item.desc.en %}
{% assign price = item.price_fmt[lang] | default: item.price_fmt.en %}


<article class="deal">

  <!-- Rank -->
  <div class="deal-rank">{{ rank }}</div>


  <!-- Media -->
  <a href="{{ item.link }}"
     class="deal-media"
     target="_blank"
     rel="nofollow noopener">

    <div class="deal-image">

      {% if item.discount %}
        <span class="deal-badge">-{{ item.discount }}%</span>
      {% endif %}

      <img src="{{ item.image }}"
           loading="lazy"
           alt="{{ title }}">

    </div>

  </a>


  <!-- Body -->
  <div class="deal-body">

    <h3 class="deal-title">
      <a href="{{ item.link }}"
         target="_blank"
         rel="nofollow noopener">
        {{ title }}
      </a>
    </h3>


    {% if desc %}
      <p class="deal-desc">{{ desc }}</p>
    {% endif %}


    <div class="deal-bottom">

      <!-- Price -->
      <div class="deal-price">
        <span class="price-now">{{ price }}</span>
      </div>


      <!-- CTA -->
      <a class="btn"
         href="{{ item.link }}"
         target="_blank"
         rel="nofollow noopener">

        {% if lang == "ru" %}Смотреть
        {% elsif lang == "kz" %}Көру
        {% else %}View
        {% endif %}

      </a>

    </div>

  </div>

</article>

{% endfor %}

</div>
