{% assign lang = page.lang | default: "en" %}
{% assign raw = site.data.items | where: "active", true %}

{% if page.cat %}
  {% assign raw = raw | where: "category", page.cat %}
{% endif %}

{% assign now = site.time | date: "%s" %}
{% assign scored = "" | split: "" %}

{% for item in raw %}

  {% assign discount = item.discount | default: 0 | times: 3 %}
  {% assign added = item.added | date: "%s" %}
  {% assign days = now | minus: added | divided_by: 86400 %}

  {% assign freshness = 60 | minus: days %}
  {% if freshness < 0 %}
    {% assign freshness = 0 %}
  {% endif %}

  {% assign score = discount | plus: freshness %}

  {% capture pack %}
{{ score }}||{{ forloop.index0 }}
  {% endcapture %}

  {% assign scored = scored | push: pack %}

{% endfor %}

{% assign scored = scored | sort %}
{% assign sorted = "" | split: "" %}

{% for pack in scored reversed %}
  {% assign parts = pack | split: "||" %}
  {% assign i = parts[1] | plus: 0 %}
  {% assign sorted = sorted | push: raw[i] %}
{% endfor %}


<div class="feed" id="dealFeed">

{% for item in sorted %}
{% assign rank = forloop.index %}

{% assign title = item.title[lang] | default: item.title.en %}
{% assign desc  = item.desc[lang]  | default: item.desc.en %}
{% assign price = item.price_fmt[lang] | default: item.price_fmt.en %}


<article class="deal">

  <div class="deal-rank">{{ rank }}</div>


  <a href="{{ item.link }}"
     class="deal-media"
     target="_blank"
     rel="nofollow noopener">

    <div class="deal-image">

      {% if item.discount %}
        <span class="deal-badge">-{{ item.discount }}%</span>
      {% endif %}

      <img src="{{ item.image }}" loading="lazy" alt="{{ title }}">

    </div>
  </a>


  <div class="deal-body">

    <h3 class="deal-title">
      <a href="{{ item.link }}" target="_blank" rel="nofollow noopener">
        {{ title }}
      </a>
    </h3>


    {% if desc %}
      <p class="deal-desc">{{ desc }}</p>
    {% endif %}


    <div class="deal-bottom">

      <div class="deal-price">
        <span class="price-now">{{ price }}</span>
      </div>


      <a class="btn"
         href="{{ item.link }}"
         target="_blank"
         rel="nofollow noopener">

        {% if lang == "ru" %}
          Смотреть
        {% elsif lang == "kz" %}
          Көру
        {% else %}
          View
        {% endif %}

      </a>

    </div>

  </div>

</article>

{% endfor %}

</div>
